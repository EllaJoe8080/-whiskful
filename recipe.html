<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Whiskful ‚Ä¢ Recipe</title>

  <!-- Nice display fonts for the text notes -->
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Oswald:wght@400;600;700&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root { --brand:#ff7a59; --bg:#fff8f3; }

    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);
      color:#222;
    }
    header{
      display:flex; align-items:center; gap:12px;
      padding:14px 16px; background:#fff;
      box-shadow:0 2px 8px rgba(0,0,0,.06);
      position:sticky; top:0; z-index:10;
    }
    header a{ text-decoration:none; color:#333; font-weight:600; }
    .wrap{ width:min(1100px,94%); margin:20px auto 60px; }

    /* Page title (inherits card title styles if saved) */
    .title{ font-weight:800; text-align:center; margin:10px 0 18px; }

    /* --- Full-image carousel --- */
    .carousel{
      position:relative;
      background:#fff;
      border-radius:12px;
      box-shadow:0 6px 20px rgba(0,0,0,.08);
      padding:14px;
      display:grid;
      gap:10px;
    }

    .stage{
      position:relative;
      width:100%;
      background:transparent;
      border-radius:0;
      box-shadow:none;
      overflow:hidden;
    }
    .stage img{
      width:100%;
      height:auto;           /* keep intrinsic aspect */
      max-height:90vh;       /* fill viewport, not beyond */
      object-fit:contain;    /* show whole image */
      display:block;
    }

    .nav-btn{
      position:absolute; top:50%; transform:translateY(-50%);
      border:0; width:42px; height:42px; border-radius:50%;
      background:#fff; box-shadow:0 6px 18px rgba(0,0,0,.2);
      cursor:pointer; display:grid; place-items:center; font-weight:800;
    }
    .nav-btn:hover{ transform:translateY(-50%) scale(1.04); }
    .prev{ left:10px; } .next{ right:10px; }

    .thumbs{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
    .thumbs button{
      width:84px; height:64px; border:2px solid transparent; border-radius:8px;
      overflow:hidden; cursor:pointer; background:#fff;
    }
    .thumbs button[aria-current="true"]{ border-color:var(--brand); }
    .thumbs img{ width:100%; height:100%; object-fit:cover; display:block; }

    .meta{ margin-top:16px; text-align:center; opacity:.85; }

    /* --- Notes toolbar & overlay --- */
    .note-bar{
      position:sticky; top:8px; z-index:20;
      display:flex; gap:10px; align-items:center; justify-content:center;
      background:#fff; padding:8px 10px; border:1px solid #eee; border-radius:12px;
      box-shadow:0 8px 20px rgba(0,0,0,.08); margin:0 auto 12px;
      width:min(900px,96%);
    }
    .note-bar .note-label{ font-size:12px; opacity:.8; display:flex; gap:6px; align-items:center; }
    .note-bar .group button{ margin-left:2px; }

    .note-layer{ position:absolute; inset:0; pointer-events:none; }

    .note{
      position:absolute; left:50%; top:50%;
      transform:translate(-50%, -50%);
      min-width:120px; max-width:90%;
      color:#2b2b2b; font-weight:800; letter-spacing:.5px;
      line-height:1.1;
      pointer-events:auto; cursor:move; user-select:text; text-align:center;

      /* default look if no font chosen */
      font-family: "Bebas Neue", Impact, "Anton", system-ui, sans-serif;
    }
    .note[contenteditable="true"]:focus{
      outline:2px dashed var(--brand); outline-offset:2px;
    }
    .note.align-left{ text-align:left; }
    .note.align-right{ text-align:right; }
  </style>
</head>
<body>
  <header>
    <a href="recipes.html">‚Üê Back</a>
    <span id="siteName" style="font-weight:800;">Whiskful</span>
  </header>

  <div class="wrap">
    <h1 id="recipeTitle" class="title">Loading‚Ä¶</h1>

    <!-- Toolbar for per-image text -->
    <div id="noteBar" class="note-bar" hidden>
      <button id="addTextBtn" type="button">‚ûï Add text</button>

      <label class="note-label">Font
        <select id="noteFont">
          <option value="">Default</option>
          <option value="'Bebas Neue', system-ui, sans-serif">Bebas Neue</option>
          <option value="'Oswald', system-ui, sans-serif">Oswald</option>
          <option value="'Montserrat', system-ui, sans-serif">Montserrat</option>
          <option value="Georgia, serif">Georgia</option>
          <option value="'Times New Roman', Times, serif">Times</option>
          <option value="'Trebuchet MS', system-ui, sans-serif">Trebuchet</option>
          <option value="system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif">System</option>
        </select>
      </label>

      <label class="note-label">Size
        <select id="noteSize">
          <option>20px</option><option selected>28px</option>
          <option>36px</option><option>48px</option><option>64px</option>
        </select>
      </label>

      <label class="note-label">Color
        <input id="noteColor" type="color" value="#2b2b2b">
      </label>

      <div class="group">
        <button type="button" data-align="left">Left</button>
        <button type="button" data-align="center">Center</button>
        <button type="button" data-align="right">Right</button>
      </div>

      <button id="deleteNoteBtn" type="button" disabled>üóëÔ∏è Delete</button>
    </div>

    <section class="carousel" id="carousel" hidden>
      <div class="stage">
        <img id="hero" alt="Recipe image"/>
        <!-- Notes overlay sits on top of the image -->
        <div id="noteLayer" class="note-layer"></div>

        <button class="nav-btn prev" id="prevBtn" aria-label="Previous">‚Äπ</button>
        <button class="nav-btn next" id="nextBtn" aria-label="Next">‚Ä∫</button>
      </div>
      <div class="thumbs" id="thumbs"></div>
      <div class="meta" id="meta"></div>
    </section>

    <p id="emptyState" hidden>We couldn‚Äôt find this recipe. Try going back and opening a card that you created.</p>
  </div>

  <script>
    /* ========== Load card and images ========== */
    const CARDS_KEY = "whiskful-cards-v1";
    function loadCards(){ try { return JSON.parse(localStorage.getItem(CARDS_KEY)) || []; } catch { return []; } }

    const params   = new URLSearchParams(location.search);
    const id       = params.get("id");
    const cards    = loadCards();
    const card     = cards.find(c => c.id === id);

    const titleEl  = document.getElementById("recipeTitle");
    const metaEl   = document.getElementById("meta");
    const carousel = document.getElementById("carousel");
    const empty    = document.getElementById("emptyState");
    const hero     = document.getElementById("hero");
    const thumbs   = document.getElementById("thumbs");
    const prevBtn  = document.getElementById("prevBtn");
    const nextBtn  = document.getElementById("nextBtn");

    let images = [];
    let idx = 0;

    if (!card){
      empty.hidden = false;
    } else {
      // Title + saved styles from the card
      titleEl.textContent = card.caption || "Untitled recipe";
      if (card.styles){
        if (card.styles.fontFamily) titleEl.style.fontFamily = card.styles.fontFamily;
        if (card.styles.fontSize)   titleEl.style.fontSize   = card.styles.fontSize;
        if (card.styles.color)      titleEl.style.color      = card.styles.color;
        if (card.styles.textAlign)  titleEl.style.textAlign  = card.styles.textAlign;
      }

      images = Array.isArray(card.images) && card.images.length ? card.images : [card.url].filter(Boolean);

      function renderHero(){
        hero.src = images[idx];
        updateThumbActive();
        onSlideChange(images[idx]); // <-- update notes overlay
      }
      function updateThumbActive(){
        [...thumbs.children].forEach((b,i)=> b.setAttribute("aria-current", i===idx ? "true" : "false"));
      }
      function goto(n){ idx = (n + images.length) % images.length; renderHero(); }

      // Build thumbs
      images.forEach((src, i) => {
        const b = document.createElement("button");
        b.innerHTML = `<img src="${src}" alt="Slide ${i+1}">`;
        b.addEventListener("click", () => { idx = i; renderHero(); });
        thumbs.appendChild(b);
      });

      // Prev/next + keyboard
      prevBtn.addEventListener("click", () => goto(idx-1));
      nextBtn.addEventListener("click", () => goto(idx+1));
      window.addEventListener("keydown", (e) => {
        if (e.key === "ArrowLeft")  goto(idx-1);
        if (e.key === "ArrowRight") goto(idx+1);
      });

      // Meta
      metaEl.textContent = `${images.length} image${images.length>1?'s':''}`;

      // Init notes system
      initNotes(card.id, images[0]);

      renderHero();
      carousel.hidden = false;
    }
  </script>

  <script>
    /* ========== Per-image text notes (annotations) with fonts ========== */
    const ANNO_KEY = "whiskful-annos-v1"; // { [cardId]: { [imageUrl]: [ {id,x,y,text,size,color,align,font} ] } }

    function loadAnnos(){
      try{ return JSON.parse(localStorage.getItem(ANNO_KEY)) || {}; } catch { return {}; }
    }
    function saveAnnos(data){
      localStorage.setItem(ANNO_KEY, JSON.stringify(data));
    }

    const noteBar   = document.getElementById('noteBar');
    const noteLayer = document.getElementById('noteLayer');
    const addBtn    = document.getElementById('addTextBtn');
    const delBtn    = document.getElementById('deleteNoteBtn');
    const sizeSel   = document.getElementById('noteSize');
    const colorInp  = document.getElementById('noteColor');
    const noteFont  = document.getElementById('noteFont');
    const alignBtns = noteBar.querySelectorAll('button[data-align]');

    let annos = loadAnnos();
    let currentCardId = null;
    let currentImage  = null;
    let selectedNoteEl = null;

    function initNotes(cardId, firstImageUrl){
      currentCardId = cardId;
      currentImage  = firstImageUrl;
      noteBar.hidden = false;
      renderNotes();
    }

    // Called whenever the hero slide changes
    function onSlideChange(newImageUrl){
      persistFromDOM();
      currentImage = newImageUrl;
      renderNotes();
    }

    function ensureStore(){
      annos[currentCardId] ||= {};
      annos[currentCardId][currentImage] ||= [];
    }

    function addNote(){
      ensureStore();
      const id = 'n' + Math.random().toString(36).slice(2,8);
      const entry = {
        id,
        x: 50, y: 50,                 // % based center position
        text: 'Type text‚Ä¶',
        size: sizeSel.value || '28px',
        color: colorInp.value || '#2b2b2b',
        align: 'center',
        font: noteFont.value || ''
      };
      annos[currentCardId][currentImage].push(entry);
      saveAnnos(annos);
      renderNotes();
      // focus newly added
      const el = noteLayer.querySelector(`[data-id="${id}"]`);
      selectNote(el);
      el.focus();
      document.execCommand('selectAll', false, null);
    }

    function renderNotes(){
      noteLayer.innerHTML = '';
      ensureStore();
      (annos[currentCardId][currentImage]).forEach(entry => {
        const el = document.createElement('div');
        el.className = `note align-${entry.align}`;
        el.setAttribute('data-id', entry.id);
        el.contentEditable = "true";
        el.textContent = entry.text;

        // position in %
        el.style.left = entry.x + '%';
        el.style.top  = entry.y + '%';
        el.style.transform = 'translate(-50%, -50%)';

        el.style.fontSize   = entry.size;
        el.style.color      = entry.color;
        if (entry.font) el.style.fontFamily = entry.font; else el.style.removeProperty('font-family');

        // selection + dragging
        el.addEventListener('pointerdown', (e) => {
          selectNote(el);
          startDrag(el, e);
        });
        el.addEventListener('input', () => schedulePersist());
        el.addEventListener('focus', () => selectNote(el));

        noteLayer.appendChild(el);
      });

      if (!noteLayer.contains(selectedNoteEl)) {
        selectedNoteEl = null;
        delBtn.disabled = true;
      }
    }

    function selectNote(el){
      selectedNoteEl = el;
      delBtn.disabled = !selectedNoteEl;
      if (selectedNoteEl){
        sizeSel.value  = selectedNoteEl.style.fontSize || '28px';
        colorInp.value = rgbToHex(getComputedStyle(selectedNoteEl).color);
        noteFont.value = selectedNoteEl.style.fontFamily || '';
      }
    }

    // Drag handling
    let dragData = null;
    function startDrag(el, e){
      e.preventDefault();
      el.focus();
      const rect = noteLayer.getBoundingClientRect();
      dragData = {
        el,
        startX: e.clientX,
        startY: e.clientY,
        box: rect,
        xPct: parseFloat(el.style.left),
        yPct: parseFloat(el.style.top)
      };
      window.addEventListener('pointermove', onDragMove);
      window.addEventListener('pointerup', endDrag);
    }
    function onDragMove(e){
      if (!dragData) return;
      const dx = e.clientX - dragData.startX;
      const dy = e.clientY - dragData.startY;
      const xPct = dragData.xPct + (dx / dragData.box.width) * 100;
      const yPct = dragData.yPct + (dy / dragData.box.height) * 100;
      dragData.el.style.left = Math.max(0, Math.min(100, xPct)) + '%';
      dragData.el.style.top  = Math.max(0, Math.min(100, yPct)) + '%';
    }
    function endDrag(){
      if (!dragData) return;
      dragData = null;
      window.removeEventListener('pointermove', onDragMove);
      window.removeEventListener('pointerup', endDrag);
      persistFromDOM();
    }

    // Toolbar events
    addBtn.addEventListener('click', addNote);
    delBtn.addEventListener('click', () => {
      if (!selectedNoteEl) return;
      ensureStore();
      const id = selectedNoteEl.dataset.id;
      annos[currentCardId][currentImage] =
        annos[currentCardId][currentImage].filter(n => n.id !== id);
      saveAnnos(annos);
      renderNotes();
    });

    sizeSel.addEventListener('change', () => {
      if (!selectedNoteEl) return;
      selectedNoteEl.style.fontSize = sizeSel.value;
      schedulePersist();
    });
    colorInp.addEventListener('input', () => {
      if (!selectedNoteEl) return;
      selectedNoteEl.style.color = colorInp.value;
      schedulePersist();
    });
    noteFont.addEventListener('change', () => {
      if (!selectedNoteEl) return;
      if (noteFont.value) selectedNoteEl.style.fontFamily = noteFont.value;
      else selectedNoteEl.style.removeProperty('font-family');
      schedulePersist();
    });
    alignBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        if (!selectedNoteEl) return;
        selectedNoteEl.classList.remove('align-left','align-center','align-right');
        selectedNoteEl.classList.add(`align-${btn.dataset.align}`);
        schedulePersist();
      });
    });

    let persistTimer = null;
    function schedulePersist(){
      clearTimeout(persistTimer);
      persistTimer = setTimeout(persistFromDOM, 250);
    }

    function persistFromDOM(){
      ensureStore();
      const list = [];
      noteLayer.querySelectorAll('.note').forEach(el => {
        const rect = noteLayer.getBoundingClientRect();
        const centerLeft = el.getBoundingClientRect().left - rect.left + el.offsetWidth/2;
        const centerTop  = el.getBoundingClientRect().top  - rect.top  + el.offsetHeight/2;
        const xPct = (centerLeft / rect.width) * 100;
        const yPct = (centerTop  / rect.height)* 100;

        list.push({
          id: el.dataset.id,
          x: Math.max(0, Math.min(100, xPct)),
          y: Math.max(0, Math.min(100, yPct)),
          text: el.textContent.trim(),
          size: el.style.fontSize || '28px',
          color: getComputedStyle(el).color,
          align: (el.classList.contains('align-right') ? 'right' :
                 el.classList.contains('align-left')  ? 'left'  : 'center'),
          font: el.style.fontFamily || ''
        });
      });
      annos[currentCardId][currentImage] = list;
      saveAnnos(annos);
    }

    // helper
    function rgbToHex(rgb){
      const m = rgb.match(/\d+/g);
      if (!m) return '#000000';
      const [r,g,b] = m.map(n => (+n).toString(16).padStart(2,'0'));
      return `#${r}${g}${b}`;
    }
  </script>
</body>
</html>
